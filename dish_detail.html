<html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="x-ua-compatible" content="ie=edge">

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="styles.css">

<head>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
	<script>
		var latitude = 51.508742;
		var longitude = -0.120850;

		//helper function that parse the url
		function getJsonFromUrl() {
			var query = location.search.substr(1);
			var result = {};
			query.split("&").forEach(function(part) {
				var item = part.split("=");
				result[item[0]] = decodeURIComponent(item[1]);
			});
			return result;
		}

		$(document).ready(function() {
			params = getJsonFromUrl();

			// Get the dish info
			$.get("http://192.17.90.133:8081", {
				request_type: 'find_dish',
				name: params['name'],
				RIN: params['RIN']
			}, function(data) {
				dish = data[0]
				// console.log(dish);
				$("#dish_name").text(dish['name']);
				$("#dish_category").text(dish['category']);
				$("#dish_score").text(dish['score']);
				if (dish['price'] != 0) {
					$("#price").text(dish['price']);
				}
				if (dish['calorie'] != 0) {
					$("#calorie").text(dish['calorie']);
				}
				if (dish['description'] != "") {
					$("#description").text(dish['description']);
				} else {
					$("#description_tag").hide();
				}
				if (dish['ingredient'] != "") {
					$("#ingredient").text(dish['ingredient']);
				} else {
					$("#ingredient_tag").hide();
				}
				$("#image").attr("src", dish['img']);
			});

			// Get the restaurant info
			$.get("http://192.17.90.133:8081", {
				request_type: 'find_restaurant',
				RIN: params['RIN']
			}, function(data) {
				restaurant = data[0]
				// console.log(restaurant);
				$("#restaurant_name").text(restaurant['name']);
				$("#address").text(restaurant['address']);
				$("#website").attr("href", restaurant['website']);
				$("#website").text(restaurant['website']);
				latitude = restaurant['latitude'];
				longitude = restaurant['longitude'];
				console.log(latitude);
				console.log(longitude);

				var destination = {
					lat: latitude,
					lng: longitude
				};
				var map = new google.maps.Map(document.getElementById('googleMap'), {
					zoom: 13,
					center: destination
				});

				// Add a marker at the center of the map.
				var marker = new google.maps.Marker({
					position: destination,
					label: restaurant['name'],
					map: map
				});

				//                var mapProp= {
				//                // center: new google.maps.LatLng(51.508742,-0.120850),
				//                center: new google.maps.LatLng(latitude,longitude),
				//                zoom:20,
				//            };
				//var map=new google.maps.Map(document.getElementById("googleMap"),mapProp);
			});

			// Get top dishes of this restaurant
			$.get("http://192.17.90.133:8081", {
				request_type: 'top_dishes',
				RIN: params['RIN']
			}, function(data) {
				// console.log(data);
				for (var i = 0; i < 3; i++) {
					var dish = data[i];
					var dish_name = dish['name'];
					var dish_image = dish['img'];
					var dish_url_format = encodeURIComponent(dish_name);
					var file_url = window.location.href.split('?')[0];

					$("#top_dishes").append('<div class="col-12 col-sm-4">\
						<figure class="figure">\
                        <a href ="' + file_url + '?name=' + dish_url_format + '&RIN=' + params['RIN'] + '">' +
						'<img src="' + dish_image + '"' +
						'class="figure-img img-fluid rounded" alt="Image">\
                            </a>\
							<figcaption class="figure-caption">' + dish_name +
						'</figcaption>\
						</figure>\
					</div>');
				}
			});

			// Comment post
			$("#post").click(function() {
				var comment = $("#comment_input").val();
				if (comment == "") {
					return;
				}
				var dish = params['name'];
				var RIN = params['RIN'];
				$.post("http://192.17.90.133:8081", {
					request_type: 'comment_upload',
					content: comment,
					dish: dish,
					RIN: RIN
				}, function(data) {
					alert('Thank you for your comment!');
					// console.log(data);
				});
			});

			$("#delete").click(function() {
				$.get("http://192.17.90.133:8081", {
					request_type: 'delete',
					name: params['name'],
					RIN: params['RIN']
				}, function(data) {
					alert('Entry deleted from database!');
				});
			});
		});

		// like button
		$(function() {
			$('.btn-like')
				.bind('click', function(event) {
					$(".btn-like").toggleClass("liked");
				})
		});
	</script>
</head>

<body>
	<!-- nav bar, absolute position -->
	<nav class="navbar navbar-expand-lg" style="width:120px;height:60px;position:absolute;right:0px;top:0px">
		<div class="dropdown">
			<button class="btn dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				<img src="if_grapes_2003194.png" class="img-fluid rounded" style="width:40px;height:40px">
  			</button>
			<div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
				<a class="dropdown-header">Sumerinlan</a>
				<a class="dropdown-item" href="#">Home</a>
				<a class="dropdown-item" href="#">History</a>
				<a class="dropdown-item" href="#">Log out</a>
			</div>
		</div>
	</nav>

	<div class="container" style="height:100vh">
		<div class="row">
			<div class="col-12 col-sm-6">
				<div class="jumbotron bg-light" style="height:100%;margin:0px;">
					<h1 class="display-1" id="dish_name">Dish Name</h1>
					<img id="image" src="" class="img-fluid" alt="Responsive image">
					<div class="d-flex justify-content-end">
						<div style="padding:10px;">
							<button type="button" class="btn btn-like" style="padding: 2px 5px;">
								<i class="material-icons">favorite_border</i> <span id="dish_score"></span>
							</button>
						</div>
						<div style="padding:10px;">
							<!-- Submit History -->
							<button type="button" class="btn btn-outline-primary" data-toggle="modal" data-target="#submitHistory">Add to History</button>
							<div class="modal fade" id="submitHistory" role="dialog">
								<div class="modal-dialog">
									<!-- Modal content-->
									<div class="modal-content">
										<div class="modal-body">
											<form>
												<div>
													<label>Additional Comments</label>
													<textarea class="form-control" rows="3" id="comment_input"></textarea>
												</div>
											</form>
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-outline-primary" id="post">Post</button>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<!-- <button type="button" class="btn btn-outline-primary" id="delete">Delete this dish</button> -->
				</div>
			</div>
			<div class="col-12 col-sm-6" style="padding-top: 60px">
				<div class="container">
					<div class="row">
						<div class="col-3">
							<p>Category</p>
						</div>
						<div class="col-9">
							<p id="dish_category">a category</p>
						</div>
					</div>
					<div class="row">
						<div class="col-3">
							<p>Price</p>
						</div>
						<div class="col-9">
							<p id="price">(No data)</p>
						</div>
					</div>
					<div class="row">
						<div class="col-3">
							<p>Calorie</p>
						</div>
						<div class="col-9">
							<p id="calorie">(No data)</p>
						</div>
					</div>
					<div class="row" id="description_tag">
						<div class="col-3">
							<p>Description</p>
						</div>
						<div class="col-9">
							<p id="description">A simple description</p>
						</div>
					</div>
					<div class="row" id="ingredient_tag">
						<div class="col-3">
							<p>Ingredient</p>
						</div>
						<div class="col-9">
							<p id="ingredient">Some ingredient</p>
						</div>
					</div>
				</div>
				<hr />

				<div class="row">
					<div class="col-12">
						<h2 class="display-2" id="restaurant_name">Miga Restaurant</h2>
					</div>
				</div>
				<div class="row">
					<div class="col-12 col-sm-8">
						<div class="container" style="padding:0px">
							<div class="row">
								<div class="col-3">
									<p>Address</p>
								</div>
								<div class="col-9">
									<p id="address">301 N Neil St #104, Champaign, Il 61820</p>
								</div>
							</div>
							<div class="row">
								<div class="col-3">
									<p>Website</p>
								</div>
								<div class="col-9">
									<a id="website" href="http://miga-restaurant.com/" , target="_blank">http://miga-restaurant.com/</a>
								</div>
							</div>
							<div class="row">
								<div class="col-12">
									<p>Top Choices</p>
								</div>
							</div>
							<div class="row" id="top_dishes">
							</div>
						</div>
					</div>
					<div id="googleMap" class="col-12 col-sm-4">
						<p>Google Map</p>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Google map api -->
	<script>
		function myMap() {
			alert(latitude);
			alert(longitude);
			//var map=new google.maps.Map(document.getElementById("googleMap"),mapProp);
		}
	</script>
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAo3DAu0kRrfxphopPonUWwbDnqPP33CU8"></script>
</body>

</html>
